name: "Example 2: Dataset Pre-Buy Inspection"

on:
  workflow_dispatch:
    inputs:
      dataset_description:
        description: 'What kind of data to inspect'
        required: true
        type: string
        default: 'Customer support tickets about refunds'
      inspection_question:
        description: 'What to verify about the dataset'
        required: true
        type: string
        default: 'How many records? What percentage mention refunds? Common themes?'

jobs:
  inspect-dataset:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install anthropic
      
      - name: üìã Start Inspection
        env:
          DATASET_DESC: ${{ github.event.inputs.dataset_description }}
          INSPECTION_Q: ${{ github.event.inputs.inspection_question }}
        run: |
          echo "## üìä Dataset Inspection Certificate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dataset Type:** $DATASET_DESC" >> $GITHUB_STEP_SUMMARY
          echo "**Inspection Question:** $INSPECTION_Q" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -Iseconds)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: üîê Load Dataset (Private - Not Logged)
        id: load
        env:
          DATASET: ${{ secrets.SAMPLE_DATASET }}
        run: |
          # Hash the dataset (without logging it)
          HASH=$(echo -n "$DATASET" | sha256sum | cut -d' ' -f1)
          SIZE=$(echo -n "$DATASET" | wc -c)
          LINES=$(echo "$DATASET" | wc -l)
          
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "lines=$LINES" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Dataset loaded from secret storage"
          echo "   Hash: ${HASH:0:16}...${HASH: -16}"
          echo "   Size: $SIZE bytes"
          echo "   Lines: $LINES"
          echo ""
          echo "‚ö†Ô∏è  Dataset content is NOT logged (only hash + metadata)"
      
      - name: üîç Inspect with LLM
        id: inspect
        env:
          DATASET: ${{ secrets.SAMPLE_DATASET }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          QUESTION: ${{ github.event.inputs.inspection_question }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import anthropic
          import hashlib
          
          dataset = os.environ['DATASET']
          question = os.environ['QUESTION']
          
          print("ü§ñ Running LLM inspection...")
          print(f"   Question: {question}")
          print("")
          
          client = anthropic.Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])
          
          prompt = f"""{question}

<dataset>
{dataset}
</dataset>

Analyze the dataset above and answer the question. Be specific with numbers and themes.
IMPORTANT: Do NOT reproduce raw dataset records in your response. Provide only aggregate statistics, counts, and thematic summaries."""
          
          response = client.messages.create(
              model="claude-sonnet-4",
              max_tokens=2000,
              messages=[{
                  "role": "user",
                  "content": prompt
              }]
          )
          
          result = response.content[0].text
          
          print("üìä Inspection Result:")
          print("=" * 60)
          print(result)
          print("=" * 60)
          print("")
          print(f"‚úÖ Analysis complete (used {response.usage.input_tokens + response.usage.output_tokens} tokens)")
          PYTHON_SCRIPT
      
      - name: üóëÔ∏è Cleanup Confirmation
        run: |
          echo "üóëÔ∏è  Dataset cleanup:"
          echo "   ‚úÖ Dataset was only in runner memory"
          echo "   ‚úÖ Runner will be destroyed after this job"
          echo "   ‚úÖ No persistent storage used"
          echo "   ‚úÖ GitHub Secrets remain encrypted"
      
      - name: üìú Generate Certificate
        if: success()
        env:
          INSPECTION_Q: ${{ github.event.inputs.inspection_question }}
          DS_HASH: ${{ steps.load.outputs.hash }}
          DS_SIZE: ${{ steps.load.outputs.size }}
          DS_LINES: ${{ steps.load.outputs.lines }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<CERT_EOF

          ## ‚úÖ Inspection Complete

          ### Dataset Metadata:
          - **Hash:** \`${DS_HASH}\`
          - **Size:** ${DS_SIZE} bytes
          - **Lines:** ${DS_LINES}
          - **Content:** ‚ùå NOT LOGGED (private)

          ### Inspection Question:
          > ${INSPECTION_Q}

          ### LLM Analysis:
          See "Inspect with LLM" step above for full analysis.

          ### Privacy Guarantees:
          - ‚ùå Raw dataset NEVER logged
          - ‚úÖ Only hash + analysis result visible
          - ‚úÖ Dataset deleted (runner destroyed)
          - ‚úÖ GitHub Secrets remain encrypted

          ### Use Case:
          This certificate proves claims about the dataset WITHOUT revealing its contents.
          Perfect for:
          - **Pre-buy inspection:** Verify data quality before purchase
          - **Data marketplace:** Prove relevance without exposure
          - **Research validation:** Verify dataset properties

          ### Trust Model:
          - ‚úÖ GitHub infrastructure (ephemeral runners)
          - ‚úÖ Open source workflow (auditable)
          - ‚úÖ Public analysis result
          - ‚ùå Private dataset (never exposed)

          ### Proof:
          - **Certificate URL:** https://github.com/${REPO}/actions/runs/${RUN_ID}
          - **Dataset Hash:** \`${DS_HASH}\`
          - **Timestamp:** $(date -Iseconds)

          ---

          **Inspection Certificate powered by GitHub Actions** ü¶û

          This proves the dataset has the claimed properties!
          CERT_EOF
      
      - name: üéâ Success
        if: success()
        env:
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          echo "üéâ Dataset inspection certificate generated!"
          echo "üìã View at: https://github.com/${REPO}/actions/runs/${RUN_ID}"
          echo ""
          echo "Share this URL to prove your dataset's value (without revealing it)"
